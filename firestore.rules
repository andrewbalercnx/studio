
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isServer() {
      return request.auth == null;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.isAdmin == true;
    }

    function isUserAdmin(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.roles.admin == true;
    }

    function isWriter() {
      return request.auth != null && request.auth.token.isWriter == true;
    }

    function isUserWriter(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.roles.writer == true;
    }
    
    match /users/{userId} {
      allow read, write: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) || request.auth.uid == userId;
    }

    match /children/{childId} {
      allow read: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) || resource.data.ownerParentUid == request.auth.uid;
      // Allow write if the user is creating a new doc for themselves, or updating one they already own.
      allow write: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) ||
                   (request.auth.uid == request.resource.data.ownerParentUid && resource == null) || // Create
                   (request.auth.uid == resource.data.ownerParentUid); // Update

      match /sessions/{sessionId} {
        allow read, write: if request.auth != null &&
          get(/databases/$(database)/documents/children/$(childId)).data.ownerParentUid == request.auth.uid;

        match /messages/{messageId} {
          allow read, write: if request.auth != null &&
            get(/databases/$(database)/documents/children/$(childId)).data.ownerParentUid == request.auth.uid;
        }
      }
    }
    
    function sessionReadableByParent() {
      return request.auth != null && (
        resource.data.parentUid == request.auth.uid ||
        (
          !(resource.data.parentUid is string) &&
          resource.data.childId is string &&
          get(/databases/$(database)/documents/children/$(resource.data.childId)).data.ownerParentUid == request.auth.uid
        )
      );
    }

    function storyBookReadableByParent() {
      return resource != null && request.auth != null && (
        resource.data.parentUid == request.auth.uid ||
        (
          !(resource.data.parentUid is string) &&
          resource.data.childId is string &&
          get(/databases/$(database)/documents/children/$(resource.data.childId)).data.ownerParentUid == request.auth.uid
        )
      );
    }

    function sessionOwnedByParent(bookId) {
      return request.auth != null && exists(/databases/$(database)/documents/storySessions/$(bookId)) &&
        get(/databases/$(database)/documents/storySessions/$(bookId)).data.parentUid == request.auth.uid;
    }
    
    function storyBookOwnedByParent(bookId) {
      return request.auth != null
        && exists(/databases/$(database)/documents/storyBooks/$(bookId))
        && get(/databases/$(database)/documents/storyBooks/$(bookId)).data.parentUid == request.auth.uid;
    }

    match /storySessions/{sessionId} {
      allow read: if isServer()
        || isAdmin()
        || isUserAdmin(request.auth.uid)
        || sessionReadableByParent();
      allow write: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) || request.resource.data.parentUid == request.auth.uid;
    }
    
    match /storySessions/{sessionId}/messages/{messageId} {
        allow read, write: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) || get(/databases/$(database)/documents/storySessions/$(sessionId)).data.parentUid == request.auth.uid;
    }

    match /storySessions/{sessionId}/events/{eventId} {
        allow read, write: if isServer()
          || isAdmin()
          || isUserAdmin(request.auth.uid)
          || get(/databases/$(database)/documents/storySessions/$(sessionId)).data.parentUid == request.auth.uid;
    }

    match /characters/{characterId} {
      allow read, write: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) || request.auth != null;
    }

    match /promptConfigs/{configId} {
      allow read: if isServer() || request.auth != null;
      allow write: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) || isWriter() || isUserWriter(request.auth.uid);
    }

    match /storyPhases/{phaseId} {
      allow read: if isServer() || request.auth != null;
      allow write: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) || isWriter() || isUserWriter(request.auth.uid);
    }

    match /storyTypes/{typeId} {
      allow read: if isServer() || request.auth != null;
      allow write: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) || isWriter() || isUserWriter(request.auth.uid);
    }

    match /storyOutputTypes/{outputTypeId} {
      allow read: if isServer() || request.auth != null;
      allow write: if isServer() || isAdmin() || isUserAdmin(request.auth.uid) || isWriter() || isUserWriter(request.auth.uid);
    }

    match /storyBooks/{bookId} {
      allow read: if isServer()
        || isAdmin()
        || isUserAdmin(request.auth.uid)
        || isWriter()
        || isUserWriter(request.auth.uid)
        || storyBookReadableByParent()
        || sessionOwnedByParent(bookId);
      allow write: if isServer()
        || isAdmin()
        || isUserAdmin(request.auth.uid)
        || (request.auth != null && request.resource.data.parentUid == request.auth.uid);
      allow list: if request.auth != null;

      match /pages/{pageId} {
        allow read: if isServer()
          || isAdmin()
          || isUserAdmin(request.auth.uid)
          || isWriter()
          || isUserWriter(request.auth.uid)
          || storyBookOwnedByParent(bookId)
          || sessionOwnedByParent(bookId);
        allow write: if isServer()
          || isAdmin()
          || isUserAdmin(request.auth.uid)
          || storyBookOwnedByParent(bookId);
      }

      match /shareTokens/{shareId} {
        allow read, write: if isServer()
          || isAdmin()
          || isUserAdmin(request.auth.uid);
      }
    }

    match /printOrders/{orderId} {
      allow read: if isServer()
        || isAdmin()
        || isUserAdmin(request.auth.uid)
        || isWriter()
        || isUserWriter(request.auth.uid)
        || (request.auth != null && resource.data.parentUid == request.auth.uid);
      allow write: if isServer()
        || isAdmin()
        || isUserAdmin(request.auth.uid)
        || isWriter()
        || isUserWriter(request.auth.uid);
    }

    match /helpWizards/{wizardId} {
      allow read: if true; // Publicly readable content
      allow write: if isServer() || isAdmin();
    }
  }
}
