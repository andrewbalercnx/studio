// Rules version: v7 - Fix children list query permission error.
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Reusable Helper Functions ---

    function isAuth() {
      return request.auth != null;
    }

    function isServer() {
      return isAuth() && request.auth.token.isServer == true;
    }

    function isAdmin() {
      return isAuth() && request.auth.token.isAdmin == true;
    }

    function isWriter() {
      return isAuth() && request.auth.token.isWriter == true;
    }

    function isHelpId(id) {
      return id.startsWith('help-');
    }

    function ownerUid(doc) {
      return doc != null ? doc.data.ownerParentUid : null;
    }

    function parentUid(doc) {
      return doc != null ? doc.data.parentUid : null;
    }

    function isOwner() {
      return isAuth() && (
        (resource != null && ownerUid(resource) == request.auth.uid &&
          (request.resource == null || ownerUid(request.resource) == ownerUid(resource))) ||
        (resource == null && ownerUid(request.resource) == request.auth.uid)
      );
    }

    function canParentReadCurrent() {
      return isAuth() && parentUid(resource) == request.auth.uid;
    }

    function canParentReadDoc(doc) {
      return isAuth() && parentUid(doc) == request.auth.uid;
    }

    function canParentModifyCurrent() {
      return isAuth() && (
        (resource != null && parentUid(resource) == request.auth.uid &&
          (request.resource == null || parentUid(request.resource) == parentUid(resource))) ||
        (resource == null && parentUid(request.resource) == request.auth.uid)
      );
    }
    
    // --- Collection Rules ---

    match /users/{userId} {
      allow read, write: if isServer() || isAdmin() || request.auth.uid == userId;
    }

    match /children/{childId} {
      allow get: if isServer() || isAdmin() || isHelpId(childId) || isOwner();
      allow list: if isServer() || isAdmin() || (isAuth() && request.query.where[0].fieldPath == 'ownerParentUid' && request.query.where[0].op == '==' && request.query.where[0].value == request.auth.uid);
      allow write: if isServer() || isAdmin() || (!isHelpId(childId) && isOwner());

      match /sessions/{sessionId} {
        allow get: if isServer() || isAdmin() || isHelpId(childId) || canParentReadCurrent();
        allow list: if isServer() || isAdmin() || isHelpId(childId) || 
            (isAuth() && exists(/databases/$(database)/documents/children/$(childId)) && get(/databases/$(database)/documents/children/$(childId)).data.ownerParentUid == request.auth.uid);
        allow write: if isServer() || isAdmin() || (!isHelpId(childId) && canParentModifyCurrent());

        match /messages/{messageId} {
          allow get: if isServer() || isAdmin() || isHelpId(childId) || canParentReadCurrent();
          allow list: if isServer() || isAdmin() || isHelpId(childId) || 
            (isAuth() && exists(/databases/$(database)/documents/children/$(childId)) && get(/databases/$(database)/documents/children/$(childId)).data.ownerParentUid == request.auth.uid);
          allow write: if isServer() || isAdmin() || (!isHelpId(childId) && canParentModifyCurrent());
        }
      }
    }
    
    match /storySessions/{sessionId} {
      allow read: if isServer() || isAdmin() || isHelpId(sessionId) || canParentReadCurrent();
      allow write: if isServer() || isAdmin() || (!isHelpId(sessionId) && canParentModifyCurrent());
    }
    
    match /storySessions/{sessionId}/{subcollection}/{docId} {
      allow read, write: if
        isServer() ||
        isAdmin() ||
        isHelpId(sessionId) ||
        (
          !isHelpId(sessionId) &&
          isAuth() &&
          exists(/databases/$(database)/documents/storySessions/$(sessionId)) &&
          canParentReadDoc(get(/databases/$(database)/documents/storySessions/$(sessionId)))
        );
    }

    match /characters/{characterId} {
      allow read: if isServer() || isAdmin() || isHelpId(characterId) || isOwner();
      allow write: if isServer() || isAdmin() || isOwner();
    }

    // Writer-managed content
    match /promptConfigs/{docId} {
      allow read: if isServer() || isAuth();
      allow write: if isServer() || isAdmin() || isWriter();
    }
    match /storyPhases/{docId} {
      allow read: if isServer() || isAuth();
      allow write: if isServer() || isAdmin() || isWriter();
    }
    match /storyTypes/{docId} {
      allow read: if isServer() || isAuth();
      allow write: if isServer() || isAdmin() || isWriter();
    }
    match /storyOutputTypes/{docId} {
      allow read: if isServer() || isAuth();
      allow write: if isServer() || isAdmin() || isWriter();
    }

    match /stories/{storyId} {
      allow read: if isServer() || isAdmin() || isWriter() || isHelpId(storyId) || canParentReadCurrent();
      allow write: if isServer() || isAdmin() || (!isHelpId(storyId) && canParentModifyCurrent());

      match /outputs/{outputId} {
        allow read: if
          isServer() ||
          isAdmin() ||
          isWriter() ||
          isHelpId(storyId) ||
          (
            isAuth() &&
            exists(/databases/$(database)/documents/stories/$(storyId)) &&
            canParentReadDoc(get(/databases/$(database)/documents/stories/$(storyId)))
          );
        allow write: if
          isServer() ||
          isAdmin() ||
          (
            !isHelpId(storyId) &&
            isAuth() &&
            exists(/databases/$(database)/documents/stories/$(storyId)) &&
            canParentReadDoc(get(/databases/$(database)/documents/stories/$(storyId)))
          );
          
        match /pages/{pageId} {
          allow read: if
            isServer() ||
            isAdmin() ||
            isWriter() ||
            isHelpId(storyId) ||
            (
              isAuth() &&
              exists(/databases/$(database)/documents/stories/$(storyId)) &&
              canParentReadDoc(get(/databases/$(database)/documents/stories/$(storyId)))
            );
          allow write: if
            isServer() ||
            isAdmin() ||
            (
              !isHelpId(storyId) &&
              isAuth() &&
              exists(/databases/$(database)/documents/stories/$(storyId)) &&
              canParentReadDoc(get(/databases/$(database)/documents/stories/$(storyId)))
            );
        }
      }

      match /shareTokens/{shareId} {
        allow read, write: if isServer() || isAdmin();
      }
    }

    match /printOrders/{orderId} {
      allow read: if isServer() || isAdmin() || isWriter() || (isAuth() && resource.data.parentUid == request.auth.uid);
      allow write: if isServer() || isAdmin() || isWriter();
    }

    match /printLayouts/{layoutId} {
      allow read: if isAuth();
      allow write: if isServer() || isAdmin();
    }

    match /helpWizards/{wizardId} {
      allow read: if isAuth();
      allow write: if isServer() || isAdmin();
    }

    match /aiFlowLogs/{logId} {
        allow read: if isServer() || isAdmin();
        allow write: if isServer();
    }
  }
}
