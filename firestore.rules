rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Reusable Helper Functions ---

    function isServer() {
      return request.auth == null;
    }

    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuth() && request.auth.token.isAdmin == true;
    }

    function isWriter() {
      return isAuth() && request.auth.token.isWriter == true;
    }

    function requestingUserIsAdmin() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.isAdmin == true;
    }

    function requestingUserIsWriter() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.isWriter == true;
    }

    function isOwner(doc) {
      return isAuth() && doc.data.ownerParentUid == request.auth.uid;
    }

    function isCreating(doc) {
      return resource == null && request.resource.data.ownerParentUid == request.auth.uid;
    }

    // A user can read a session/story if they are the parent owner.
    // This handles both direct parentUid and legacy childId linking.
    function canParentRead(doc) {
      return isAuth() && (
        doc.data.parentUid == request.auth.uid ||
        (
          doc.data.childId is string &&
          get(/databases/$(database)/documents/children/$(doc.data.childId)).data.ownerParentUid == request.auth.uid
        )
      );
    }
    
    // --- Collection Rules ---

    match /users/{userId} {
      allow read, write: if isServer() || isAdmin() || requestingUserIsAdmin() || request.auth.uid == userId;
    }

    match /children/{childId} {
      allow read: if isServer() || isAdmin() || requestingUserIsAdmin() || childId.startsWith('help-') || isOwner(resource);
      allow write: if isServer() || isAdmin() || requestingUserIsAdmin() || isCreating(resource) || isOwner(resource);

      match /sessions/{sessionId} {
        allow read: if childId.startsWith('help-') || (isAuth() && get(/databases/$(database)/documents/children/$(childId)).data.ownerParentUid == request.auth.uid);
        allow write: if isAuth() && get(/databases/$(database)/documents/children/$(childId)).data.ownerParentUid == request.auth.uid;

        match /messages/{messageId} {
          allow read: if childId.startsWith('help-') || (isAuth() && get(/databases/$(database)/documents/children/$(childId)).data.ownerParentUid == request.auth.uid);
          allow write: if isAuth() && get(/databases/$(database)/documents/children/$(childId)).data.ownerParentUid == request.auth.uid;
        }
      }
    }
    
    match /storySessions/{sessionId} {
      allow read: if isServer() || isAdmin() || requestingUserIsAdmin() || sessionId.startsWith('help-') || canParentRead(resource);
      allow write: if isServer() || isAdmin() || requestingUserIsAdmin() || request.resource.data.parentUid == request.auth.uid;
    }
    
    match /storySessions/{sessionId}/{subcollection}/{docId} {
        allow read, write: if isServer() || isAdmin() || requestingUserIsAdmin() || (isAuth() && get(/databases/$(database)/documents/storySessions/$(sessionId)).data.parentUid == request.auth.uid);
    }

    match /characters/{characterId} {
      allow read: if isServer() || isAdmin() || requestingUserIsAdmin() || characterId.startsWith('help-') || isAuth();
      allow write: if isServer() || isAdmin() || requestingUserIsAdmin() || (isAuth() && (isCreating(request.resource) || isOwner(resource)));
    }

    // Writer-managed content
    match /{collection}/{docId} where collection in ['promptConfigs', 'storyPhases', 'storyTypes', 'storyOutputTypes'] {
      allow read: if isServer() || isAuth();
      allow write: if isServer() || isAdmin() || requestingUserIsAdmin() || isWriter() || requestingUserIsWriter();
    }

    match /stories/{storyId} {
      allow read: if isServer() || isAdmin() || requestingUserIsAdmin() || isWriter() || requestingUserIsWriter() || storyId.startsWith('help-') || canParentRead(resource);
      allow write: if isServer() || isAdmin() || requestingUserIsAdmin() || (isAuth() && request.resource.data.parentUid == request.auth.uid);
      allow list: if isAuth();

      match /outputs/{outputId} {
        allow read: if isServer() || isAdmin() || requestingUserIsAdmin() || isWriter() || requestingUserIsWriter() || canParentRead(get(/databases/$(database)/documents/stories/$(storyId)));
        allow write: if isServer() || isAdmin() || requestingUserIsAdmin() || canParentRead(get(/databases/$(database)/documents/stories/$(storyId)));
          
        match /pages/{pageId} {
          allow read: if isServer() || isAdmin() || requestingUserIsAdmin() || isWriter() || requestingUserIsWriter() || canParentRead(get(/databases/$(database)/documents/stories/$(storyId)));
          allow write: if isServer() || isAdmin() || requestingUserIsAdmin() || canParentRead(get(/databases/$(database)/documents/stories/$(storyId)));
        }
      }

      match /shareTokens/{shareId} {
        allow read, write: if isServer() || isAdmin() || requestingUserIsAdmin();
      }
    }

    match /printOrders/{orderId} {
      allow read: if isServer() || isAdmin() || requestingUserIsAdmin() || isWriter() || requestingUserIsWriter() || (isAuth() && resource.data.parentUid == request.auth.uid);
      allow write: if isServer() || isAdmin() || requestingUserIsAdmin() || isWriter() || requestingUserIsWriter();
    }

    match /printLayouts/{layoutId} {
      allow read: if true;
      allow write: if isServer() || isAdmin() || requestingUserIsAdmin();
    }

    match /helpWizards/{wizardId} {
      allow read: if true;
      allow write: if isServer() || isAdmin();
    }

    match /aiFlowLogs/{logId} {
        allow read: if isServer() || isAdmin() || requestingUserIsAdmin();
        allow write: if isServer();
    }
  }
}
